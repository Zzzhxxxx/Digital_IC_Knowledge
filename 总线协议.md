# 1 I2C 总线
## 1.1 基本特点
- 总线类型：多主多从（Multi-Master Multi-Slave）
- 通信方式：串行半双工
- 通信速度：I2C 提供了不同的传输速率，包括标准模式（100 kbps）、快速模式（400 kbps）、快速模式+（1 Mbps）、高速度模式（3.4 Mbps）等。
- 信号线：I2C 使用两条信号线进行通信。
    - SCL（Serial Clock Line）：时钟信号，由主设备生成。
	- SDA（Serial Data Line）：数据信号，用于传输数据和地址。

## 1.2 基本信号
- I2C 使用两条信号线进行通信，这些信号的组合决定了通信的流程。
	- 启动信号：由主设备发出。启动信号是 SDA 线在 SCL 线为高电平时从高到低的跳变。启动信号表示通信的开始，所有从设备必须检测这个信号。
	- 停止信号：由主设备发出。停止信号是 SDA 线在 SCL 线为高电平时从低到高的跳变。停止信号表示通信结束。
	- 确认信号：在每个字节传输之后，从设备需要发送一个确认信号 `ACK` 以表明成功接收到数据。否则发送非确认信号 `NACK`，表明接收失败或者无数据可接收。

## 1.3 传输过程
- I2C 数据传输遵循以下步骤：
	1. 起始信号 `START`：主设备发送起始信号，表示开始一次通信。
	2. 从设备地址：主设备发送从设备的地址，指明目标设备。
	3. 读/写位：主设备紧跟着地址位发送一个读/写位，表示本次操作是读取还是写入：`0` 表示写操作，`1` 表示读操作。
	4. 确认信号 `ACK`：从设备发送确认信号，表示已正确接收到地址信息。
	5. 数据传输：主设备或从设备开始传输数据（具体取决于读/写操作）。每次传输一个字节，接收方发送确认信号 `ACK`。此步骤可重复多次。
	6. 停止信号 `STOP`：当数据传输完成后，主设备发送停止信号，表示通信结束。

---
# 2 AMBA 总线
- AMBA：Advanced Microcontroller Bus Architecture，高级处理器总线架构。不同的速率需求构成了为高性能 SoC 设计的通信标准，主要包括：APB 高级外围总线、AHB 高级高性能总线和 AXI 高级可拓展接口。

- 主要的 AMBA 协议发展史：

![[image-20241210153514543.png]]

- 完整发展史：

![[image-20241210153740075.png]]

- 典型的 AMBA-AHB 系统架构：

![[image-20241210163551841.png]]

- 典型的 AMBA3 AXI 总线协议的 SoC 架构：

![[image-20241210163630191.png|450]]

- [arm 官方文档](https://www.arm.com/architecture/system-architectures/amba/amba-specifications)

---
## 2.1 APB 总线
- APB：Advanced Peripheral Bus，高级外围总线。主要应用在低速且低频率的外围，可针对外围设备做功率消耗及复杂接口的最佳化。APB 在 AHB 和低带宽的外围设备之间提供了通信桥梁，所以 APB 是 AHB 的二级拓展总线。
- 总线类型：单主多从（主设备一般为 APB Bridge）
- 通信方式：并行半双工

### 2.1.1 信号总览

![[image-20250108132522778.png]]

- 英文版（官方版 APB4）：

![[image-20241216160752196.png]]

---
## 2.2 AHB 总线
- AHB：Advanced High-performance Bus，高级高性能总线。主要针对高速率、高频宽及快速系统模块所设计的总线，可以连接在如微处理器、芯片上或芯片外的内存模块和 DMA 等高效率总线。
- 总线类型：单主多从（可扩展为多主）
- 通信方式：并行半双工

---
## 2.3 AXI 总线
- AXI：Advanced eXtensible Interface，高级可拓展接口。它设计的初衷是提供高带宽、低延迟的数据传输机制，同时具有灵活性和易扩展性，适合复杂的片上系统。
- 总线类型：多主多从
- 通信方式：并行全双工

### 2.3.1 独立读写通道
- AXI 具有独立的读和写通道，允许读写操作并行进行。这种双向独立结构非常适合多核处理器和复杂的总线系统，能够最大化带宽利用率。五个独立的传输通道：
	- 读地址通道 `AR`：用于传输读操作的地址和控制信息。
	- 读数据通道 `R`：用于返回读数据和相关响应。
	- 写地址通道 `AW`：用于传输写操作的地址和控制信息。
	- 写数据通道 `W`：用于传输写入的数据。
	- 写响应通道 `B`：用于返回写操作的结果和响应。
- 典型的数据总线宽度包括 32 位、64 位、128 位、256 位、512 位等，但在高性能系统中可以选择更高的数据宽度。

![[image-20241108131433838.png|650]]

![[image-20241108131451214.png|650]]

- 每个通道都有自己的握手信号对：
	- 写地址通道：`AWVALID` / `AWREADY `
	- 写数据通道：`WVALID` / `WREADY `
	- 写响应通道：`BVALID` / `BREADY `
	- 读地址通道：`ARVALID` / `ARREADY `
	- 读数据通道：`RVALID` / `RREADY `

### 2.3.2 突发传输类型
- AXI 支持多种突发传输类型 `burst type`（例如固定突发 `FIXED`、递增突发 `INCR`、回绕突发 `WRAP`），一次传输可以包括最多 256 个数据拍 `beats`，从而提高传输效率。
- 对于读操作，`ARBURST` 信号控制突发传输类型；对于写操作，`AWBURST` 信号控制突发传输类型。`2'b00` 表示 `FIXED`， `2'b01` 表示 `INCR`，`2'b10` 表示 `WRAP`，`2'b11` 保留（为将来的可能扩展保留）。
- 除了通过 `ARBURST` 和 `AWBURST` 信号指定突发类型之外，主设备还需要指定以下两个参数，它们共同定义了每次突发传输的详细特性：
	- 突发长度 `AxLEN`：
	    - 这个信号指定了一次突发传输中包含的数据拍数 `beats`。在 AXI 中，突发长度的范围可以是 1 到 256，这意味着一次突发传输最多可以包含 256 个数据拍。
	    - 信号 `AxLEN`（其中 `x` 表示 `A` 或 `R`，即用于读或写）是一个 8 位信号，表示突发传输的长度为 `AxLEN + 1` 拍。例如，`AxLEN` 为 `3` 表示一共有 `4` 个数据拍。
	- 突发大小 `AxSIZE`：
	    - `AxSIZE` 信号用于指定每次数据拍的数据宽度，即每次传输的数据量大小。它表示的数据宽度是 2 的幂次方，例如 ` 1 byte (00) `, ` 2 bytes (01) `, ` 4 bytes (10) `，等等。
	    - 这决定了每个数据拍传输的具体数据量大小，比如 32 位、64 位、128 位等。
- 主设备在发起一次读或写操作时，首先通过地址通道 `AxADDR` 发送目标地址，然后结合突发类型 `AxBURST`、突发长度 `AxLEN` 和突发大小 `AxSIZE`）这几个控制信号一起，定义了一次突发传输的特性。

#### 2.3.2.1 固定突发 `FIXED` 
- 概念：在固定突发类型中，每个数据拍 `beat` 的地址是固定的，即所有数据都是从同一个地址中读取或写入的。
- 工作原理：在这种模式下，所有数据拍都会对同一个内存地址进行读或写。突发长度可以是任意数量的拍，但访问的地址不会改变。例如，如果基地址是 `0x1000`，并且突发长度为 `4 beats`，那么所有 4 个数据拍都将访问同样的地址 `0x1000`。
- 应用场景：FIFO 缓冲区。固定突发非常适用于访问 FIFO 等数据结构，因为FIFO的每次写操作或读操作都是对相同的物理地址进行，而内部数据结构是自动推进的。
- 特点：
	- 地址不变：每一个数据拍的地址都相同。
	- 适用于特定类型的存储结构：适合那些在物理上是固定地址，但逻辑上数据可以以序列形式进入或读出的情况，例如 FIFO 缓冲器或某些特定的硬件寄存器。

#### 2.3.2.2 递增突发 `INCR`
- 概念：递增突发是最常见的突发类型，适用于访问连续的内存地址。每个数据拍的地址会在前一个数据拍的地址基础上递增，通常是按数据宽度递增。
- 工作原理：在递增突发模式下，第一个数据拍使用基地址，之后的每个数据拍的地址都会按照一个固定的步长递增。递增的步长通常等于数据宽度。例如，如果数据宽度是 `4 bytes`，基地址是 `0x1000`，突发长度是 `4 beats`，那么各个数据拍的地址分别为 `0x1000, 0x1004, 0x1008, 0x100C`。地址递增的方式和数据宽度有关，这样可以确保每个数据拍访问的是连续的内存位置。
- 应用场景：
	- 内存块读取或写入：递增突发适用于访问连续的内存块，例如从内存读取一个数组，或者将一大块数据写入连续的内存地址。
	- DMA 传输：DMA（Direct Memory Access）控制器通常使用递增突发来高效地搬运大量的内存数据。
- 特点：
	- 地址递增：每个数据拍的地址递增，适合顺序的内存访问。
	- 灵活性强：适合大多数应用场景，尤其是那些需要访问连续存储器的情况。
	- 高效利用总线：通过减少地址传输的开销，递增突发能有效提高数据传输效率和总线利用率。

#### 2.3.2.3 回绕突发 `WRAP`
- 概念：回绕突发是一种特殊类型的递增突发，它会在达到某个地址边界后回绕到初始边界，以形成一个“包装”效果。它主要用于实现循环缓冲区的访问。
- 工作原理：回绕突发类似于递增突发，但当地址递增到一个特定的边界（通常是与突发长度和数据宽度相关）时，地址会自动回到一个起始位置。例如，如果基地址是 `0x1000`，突发长度为 `8 beats`，数据宽度为 `4 bytes`，并且设置了包装长度为 `16 bytes`，那么各个数据拍的地址将是：`0x1000, 0x1004, 0x1008, 0x100C, 0x1000, 0x1004, 0x1008, 0x100C`，当地址递增到 `0x100C` 后，下一步就会回绕到 `0x1000`，形成一个环形地址序列。
- 应用场景：环形缓冲区（Circular Buffer）。包装突发特别适用于访问环形缓冲区。这种缓冲区结构常见于数据流应用，如音频、视频处理等，包装突发可以有效地将数据存储在一个固定大小的循环区域内，不需要管理复杂的地址偏移。
- 特点：
	- 地址回绕：在到达包装边界后，地址会回到起始位置，从而形成环状访问。
	- 适合环形存储需求：包装突发对需要循环使用存储空间的应用非常有用，可以简化硬件设计和逻辑。

#### 2.3.2.4 总结对比

| 突发类型 | 地址变化 | 典型应用场景 | 优势 |
| ---- | ---- | ---- | ---- |
| 固定突发 | 地址不变 | FIFO、寄存器 | 适合需要重复访问相同地址的场景 |
| 递增突发 | 地址递增 | 内存块读取/写入、DMA | 高效利用带宽，减少地址握手的开销 |
| 包装突发 | 地址递增至边界后回绕 | 环形缓冲区、缓存行填充 | 简化环形缓冲区的管理，适合流式数据 |

### 2.3.3 协议特性
- Outstanding（未完成事务）：允许同时存在多个未完成的请求，增加并发性，减少等待。
- Out-of-Order（乱序）：允许请求的响应不按顺序进行，提高灵活性和资源利用率。
- Interleaving（交错）：允许突发传输的数据在不同事务之间交错，提高数据传输的并发性和效率。

---
# 3 PCIe 总线
## 3.1 基本概念
- PCIe（Peripheral Component Interconnect Express）是由 PCI-SIG 组织开发的一种高速串行总线协议，用于计算机主板中各类设备（如显卡、SSD、网卡等）之间的高速通信。相比之前的并行总线技术，PCIe 具有高带宽、低延迟和点对点链路等优势，广泛用于现代计算机系统中。

- 与之前的并行总线不同，PCIe 使用串行通信，每条链路（称为 Lane）包含一对差分信号（TX+ 和 TX-）用于发送数据，另一对差分信号（RX+ 和 RX-）用于接收数据。也就是说，每条 Lane 包含 4 条信号线。每个 PCIe 链路都是全双工的，意味着可以同时进行发送和接收数据。链路可以由1、4、8、16 或 32 条 Lane 组成，更多的通道数意味着更高的带宽。

## 3.2 版本发展

| 版本 | 数据速率 | 带宽 | 编码效率 |
| ---- | ---- | ---- | ---- |
| PCIe 1.0 | 2.5GT/s | 250MB/s | 8/10 |
| PCIe 2.0 | 5.0GT/s | 500MB/s | 8/10 |
| PCIe 3.0 | 8.0GT/s | 1GB/s | 128/130 |
| PCIe 4.0 | 16.0GT/s | 2GB/s | 128/130 |
| PCIe 5.0 | 32.0GT/s | 4GB/s | 128/130 |
| PCIe 6.0 | 64.0GT/s | 8GB/s | 97.5%（PAM4） |

- 数据速率和带宽之间有什么关系？
	- 搞清楚这个问题之前，应该先区分 GT/s（Gigatransfers per second）和 Gbps（Gigabits per second）的区别。GT/s 表示每秒的传输次数（数据速率），Gbps 表示每秒传输的比特数（有效数据速率），即 $GT/s \times \eta = Gbps$。
	- 举个例子，对于 PCIe 1.0 来讲，数据速率为 2.5GT/s，编码效率为 8/10，那么有效数据速率即为 $2.5GT/s \times 8/10 = 2Gbps$，带宽为 $2Gbps / 8 = 250MB/s$。对于 PCIe 5.0 来讲，数据速率为 32GT/s，编码效率为 128/130，那么有效数据速率即为 $32GT/s \times 128/130 = 31.38Gbps$，带宽为 $31.38Gbps / 8 \approx 3.92GB/s \approx 4GB/s$。注意，以上计算均针对一条 Lane，如果计算多条 Lane 的数据传输能力还需要乘 Lane 数。
